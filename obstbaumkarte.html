<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Obstbaumkarte - OSM</title>

  <!-- Leaflet -->
  <link rel="stylesheet" crossorigin="" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="/>
  <script crossorigin="" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="></script>

  <link rel="stylesheet" crossorigin="" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" crossorigin="" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script crossorigin="" src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>

  <!-- Leaflet-Overpass -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-overpass-layer@2.9.0/dist/OverPassLayer.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/leaflet-overpass-layer@2.9.0/src/OverPassLayer.min.css" rel="stylesheet">

  <!-- Custom Styles -->
  <style>
#map { width:100%;height:100% }
.obst-tooltip-overwrite {
  background-color:transparent;
  border:none;
  border-bottom-color:none;
  box-shadow:none;
}
.obst-tooltip-overwrite::before {
  display:none;
}
  </style>

</head>
<body>

  <div id="map"></div>

  <!-- MAIN -->
  <script>

/* Get a tag from an OSM element, but prioritze :de version if available */
function getTagDe(basetag, e) {
    let ret = "unknown";
    if (basetag in e.tags) {
      ret = e.tags[basetag];
    }
    if (basetag.concat(':de') in e.tags) {
      ret = e.tags[basetag.concat(':de')];
    }
    return ret;
}

// copied and adapted from OverPassLayer.js
function getPoiPopupHTML(tags, id) {
    let row;
    const link = document.createElement('a');
    const table = document.createElement('table');
    const div = document.createElement('div');

    link.href = `https://www.openstreetmap.org/edit?editor=id&node=${id}`;
    link.appendChild(document.createTextNode('Edit this entry in iD'));

    table.style.borderSpacing = '10px';
    table.style.borderCollapse = 'separate';

    for (const key in tags) {
      row = table.insertRow(0);
      row.insertCell(0).appendChild(document.createTextNode(key));
      if (key == "mapillary") {
	let node = document.createElement('a');
	node.target = '_blank';
	node.href = "https://www.mapillary.com/app/?focus=photo&pKey=" + tags[key];
	node.innerHTML = tags[key];
        row.insertCell(1).appendChild(node);
      } else {
        row.insertCell(1).appendChild(document.createTextNode(tags[key]));
      }
    }

    div.appendChild(link);
    div.appendChild(table);

    return div;
  }

function OverPassLayer_OnSuccess(data) {
  for (let i = 0; i < data.elements.length; i++) {
    let pos;
    const e = data.elements[i];
    if (e.id in this._ids) {
      continue;
    }
    this._ids[e.id] = true;

    if (e.type === 'node') {
      pos = L.latLng(e.lat, e.lon);
    } else {
      pos = L.latLng(e.center.lat, e.center.lon);
    }

    let icon = icon_unknown;
    let species = "unknown";
    if ('species' in e.tags) {
      species = e.tags.species.toLowerCase();
      switch (species) {
        case 'malus': icon = icon_malus; break;
        case 'pyrus': icon = icon_pyrus; break;
      }
    }

    let popupContent = getPoiPopupHTML(e.tags, e.id);

    let tooltipname = getTagDe('taxon', e);
    if (tooltipname == "unknown") {
      tooltipname = getTagDe('species', e);
    }
    let marker = L.marker(pos, {icon: icon});
    marker.bindTooltip(tooltipname, {
      permanent: true,
      direction: 'bottom',
      className: 'obst-tooltip-overwrite',
      offset: new L.Point(0, 0),
    });
    const popup = L.popup().setContent(popupContent);
    marker.bindPopup(popup);
    markers_trees.addLayer(marker);
  }
}

/* Icon definitions */
const icon_size = 20;
const icon_unknown = L.icon({
    iconSize: [icon_size, icon_size],
    iconAnchor: [icon_size/2, icon_size/2],
    iconUrl: 'https://img.icons8.com/pulsar-line/48/tree.png'
});
const icon_malus = L.icon({
    iconSize: [icon_size, icon_size],
    iconAnchor: [icon_size/2, icon_size/2],
    iconUrl: 'https://img.icons8.com/ios/50/apple.png',
});
const icon_pyrus = L.icon({
    iconSize: [icon_size, icon_size],
    iconAnchor: [icon_size/2, icon_size/2],
    iconUrl: 'https://img.icons8.com/ios/50/pear.png',
});

/* map and maplayer definitions */
const layer_osm = new L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 25,
    attribution: 'Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
});

const layer_esri_world_imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 25,
    maxNativeZoom: 19,
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
});

const layer_google_maps = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
});

const layer_trees = new L.OverPassLayer({
  query: '(node({{bbox}})[natural=tree][species];);out qt;',
  minZoom: 13,
  debug: true,
  onSuccess: OverPassLayer_OnSuccess,
  attribution: 'POI via <a href="http://www.overpass-api.de/">Overpass API</a> | Icons via <a href="https://icons8.com">Icons8</a>',
});
const markers_trees = new L.markerClusterGroup();

const base_layers = {
    'OpenStreetMap': layer_osm,
    'ESRI World Imagery': layer_esri_world_imagery,
    'Google Maps': layer_google_maps,
};

const overlay_layers = {
    'Trees': markers_trees,
};

const map = new L.map('map', {
    center: [48.29, 10.201],
    zoom: 19,
    layers: [layer_osm, layer_trees, markers_trees],
});
const layer_control = new L.control.layers(base_layers, overlay_layers).addTo(map);

  </script>

</body>
</html>
