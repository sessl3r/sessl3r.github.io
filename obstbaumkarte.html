<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Obstbaumkarte - OSM</title>

  <!-- Leaflet -->
  <link rel="stylesheet" crossorigin="" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="/>
  <script crossorigin="" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="></script>

  <link rel="stylesheet" crossorigin="" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" crossorigin="" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script crossorigin="" src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>

  <!-- Leaflet-Overpass -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-overpass-layer@2.9.0/dist/OverPassLayer.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/leaflet-overpass-layer@2.9.0/src/OverPassLayer.min.css" rel="stylesheet">

  <!-- Custom Styles -->
  <style>
#map { width:100%;height:100% }
.obst-tooltip-overwrite {
  background-color:transparent;
  border:none;
  border-bottom-color:none;
  box-shadow:none;
}
.obst-tooltip-overwrite::before {
  display:none;
}

.d-none {
  display:none;
}

.mapillary-img {
  width:100%;
}
  </style>

</head>
<body>

  <div id="map"></div>

  <!-- MAIN -->
  <script defer>

mycache = {
  mapillary: {},
};

/* Get a tag from an OSM element, but prioritze :de version if available */
function getTagDe(basetag, e) {
    let ret = "unknown";
    if (basetag in e.tags) {
      ret = e.tags[basetag];
    }
    if (basetag.concat(':de') in e.tags) {
      ret = e.tags[basetag.concat(':de')];
    }
    return ret;
}

// retrieve image url from mapillary api
async function getMapillaryUrl(id) {
  if (id in mycache.mapillary) {
    return mycache.mapillary[id];
  }

  const params = new URLSearchParams({
    fields: 'thumb_256_url',
    access_token: 'MLY|29846375581644343|ee420adbcfa656334152a6bc99b85f93',
  });

  const response = await fetch(`https://graph.mapillary.com/${id}?${params}`);
  const json = await response.json();
  mycache.mapillary[id] = json.thumb_256_url;
  return json.thumb_256_url;
}

async function getPoiPopupHTML(tags, id) {
  const div = document.createElement('div');
  let html = "";
  div.id = "popup-osm-" + id;
  let titel = "";
  if ('species:de' in tags) {
    titel += tags['species:de'];
  } else if (tags.species) {
    titel += tags.species;
  }
  if (tags.taxon) {
    titel += " : " + tags.taxon;
  }
  if (tags.start_date) {
    titel += " (" + tags.start_date + ")";
  }
  html = `<a target='_blank' href='https://www.openstreetmap.org/edit?editor=id&node=${id}'><h2>${titel}</h2></a>`;
  if (tags.mapillary) {
    html += `<a href='https://www.mapillary.com/app/?focus=photo&pKey=${tags.mapillary}' target='_blank'><img class='mapillary-img' src=''></a>`
  }

  div.innerHTML = html;
  return div;
}

async function OverPassLayer_OnSuccess(data) {
  for (let i = 0; i < data.elements.length; i++) {
    let pos;
    const e = data.elements[i];
    if (e.id in this._ids) {
      continue;
    }
    this._ids[e.id] = true;

    if (e.type === 'node') {
      pos = L.latLng(e.lat, e.lon);
    } else {
      pos = L.latLng(e.center.lat, e.center.lon);
    }

    let icon = icon_unknown;
    let species = "unknown";
    if ('species' in e.tags) {
      species = e.tags.species.toLowerCase();
      switch (species) {
        case 'malus': icon = icon_malus; break;
        case 'pyrus': icon = icon_pyrus; break;
      }
    }

    let popupContent = await getPoiPopupHTML(e.tags, e.id);

    let tooltipname = getTagDe('taxon', e);
    if (tooltipname == "unknown") {
      tooltipname = getTagDe('species', e);
    }

    let marker = L.marker(pos, {icon: icon});
    marker.mydata = e;
    marker.on('click', async function(e) {
      if (!e.target.mydata.tags.hasOwnProperty('mapillary')) { return; }
      let url = await getMapillaryUrl(e.target.mydata.tags.mapillary);
      let node = e.target._popup._content.getElementsByTagName('img')[0];
      node.src = url;

    });
    marker.bindTooltip(tooltipname, {
      permanent: true,
      direction: 'bottom',
      className: 'obst-tooltip-overwrite',
      offset: new L.Point(0, 0),
    });
    const popup = L.popup().setContent(popupContent);
    marker.bindPopup(popup);
    markers_trees.addLayer(marker);
  }
}

/* Icon definitions */
const icon_size = 20;
const icon_unknown = L.icon({
    iconSize: [icon_size, icon_size],
    iconAnchor: [icon_size/2, icon_size/2],
    iconUrl: 'https://img.icons8.com/pulsar-line/48/tree.png'
});
const icon_malus = L.icon({
    iconSize: [icon_size, icon_size],
    iconAnchor: [icon_size/2, icon_size/2],
    iconUrl: 'https://img.icons8.com/ios/50/apple.png',
});
const icon_pyrus = L.icon({
    iconSize: [icon_size, icon_size],
    iconAnchor: [icon_size/2, icon_size/2],
    iconUrl: 'https://img.icons8.com/ios/50/pear.png',
});

/* map and maplayer definitions */
const layer_osm = new L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 25,
    maxNativeZoom: 19,
    attribution: 'Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
});

const layer_esri_world_imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 25,
    maxNativeZoom: 19,
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
});

const layer_google_maps = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 25,
    maxNativeZoom: 21,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
});

const layer_trees = new L.OverPassLayer({
  query: '(node({{bbox}})[natural=tree][species];);out qt;',
  minZoom: 13,
  debug: true,
  onSuccess: OverPassLayer_OnSuccess,
  attribution: 'POI via <a href="http://www.overpass-api.de/">Overpass API</a> | Icons via <a href="https://icons8.com">Icons8</a>',
});
const markers_trees = new L.markerClusterGroup();

const base_layers = {
    'OpenStreetMap': layer_osm,
    'ESRI World Imagery': layer_esri_world_imagery,
    'Google Maps': layer_google_maps,
};

const overlay_layers = {
    'Trees': markers_trees,
};

const map = new L.map('map', {
    center: [48.29, 10.201],
    zoom: 19,
    layers: [layer_osm, layer_trees, markers_trees],
});
const layer_control = new L.control.layers(base_layers, overlay_layers).addTo(map);

  </script>

</body>
</html>
